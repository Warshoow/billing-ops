# syntax=docker/dockerfile:1

FROM node:22-alpine

# Installer pnpm
RUN corepack enable && corepack prepare pnpm@9.0.0 --activate

WORKDIR /app

# Copier les fichiers de configuration du workspace
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./

# Copier tous les package.json des workspaces
COPY packages/shared-types/package.json ./packages/shared-types/
COPY packages/ui/package.json ./packages/ui/
COPY packages/eslint-config/package.json ./packages/eslint-config/
COPY packages/typescript-config/package.json ./packages/typescript-config/
COPY apps/api/package.json ./apps/api/

# Installer toutes les dépendances du monorepo
RUN pnpm install --frozen-lockfile

# Copier le code source complet
COPY packages ./packages
COPY apps/api ./apps/api

# Rester à la racine du monorepo
WORKDIR /app

# Exposer le port de l'API
EXPOSE 3333

# Démarrer l'API en changeant dans le bon répertoire
CMD ["sh", "-c", "cd apps/api && pnpm dev"]
